%include <head.h>

# ======================================================================
# Run LOCALLY
# ======================================================================
export WK=%WK%

if [[ %SET_TO_TEST_SCRIPT% = true ]] ; then
   echo "Test only"
else
   cd $WK;
   
   # Allow test to be rerun. This can fail
   Client/bin/%COMPILER_VERSION%/release/ecflow_client --terminate yes || true
   
   # Clear up
   rm -rf `hostname`.*
   
   # Load the latest valgrind. 
   # Enable module capability for korn shell 
   # The alternative is to source .profile, in ECF_JOB_CMD, however that affect all jobs, i.e.
   #     task.add_variable("ECF_JOB_CMD","rsh %LOCAL_HOST% -l %USER% 'source ~/.profile; %ECF_JOB% > %ECF_JOBOUT% 2>&1'")
   source /usr/local/apps/module/init/ksh
   module load valgrind/3.9.0
   
   # test server for memory leaks, & give it time to start
   valgrind --leak-check=full --show-reachable=yes --error-exitcode=1 Server/bin/%COMPILER_VERSION%/release/ecflow_server --ecfinterval=3 &
   sleep 10

   export ECF_NODE=localhost
   Client/bin/%COMPILER_VERSION%/release/s_client
   
   # This test will terminate the server at the end of the test
   Test/bin/%COMPILER_VERSION%/release/s_test
   
   # wait for server to exit & valgrind report
   sleep 2
   
   # Clear up
   rm -rf `hostname`.*
fi

%include <tail.h>