%include <head.h>

# ======================================================================
# Run LOCALLY
# ======================================================================
export WK=%WK%

      
if [[ %SET_TO_TEST_SCRIPT% = true ]] ; then
   echo "Test only"
else
   cd $WK;
   
   # Create the migration files, for the currently running servers
   while read nick host port
   do
      # Ping server 
      LOG="--host $host --port $port"
      Client/bin/%COMPILER_VERSION%/release/ecflow_client $LOG --ping || continue
      
      # determine version
      version=$(ecflow_client $LOG --server_version)
      echo $nick $host $port $version
      /usr/local/apps/ecflow/$version/bin/ecflow_client $LOG --migrate > /var/tmp/ma0/ECFLOW_TEST/migration/$host.$port.def
      
      # This will generate a file, with .mig extention
      python Pyext/migrate/ecflow_migrate.py /var/tmp/ma0/ECFLOW_TEST/migration/$host.$port.def
      
      # rm unused file, to stop test_migration from processing it.
      rm -rf /var/tmp/ma0/ECFLOW_TEST/migration/$host.$port.def
      
   done < /usr/local/apps/ecflow/current/lib/servers
   
   # list directory contents
   ls -la /var/tmp/ma0/ECFLOW_TEST/migration/
 
   # This will read from directory /var/tmp/ma0/ECFLOW_TEST/migration/
   Client/bin/%COMPILER_VERSION%/release/test_migration
fi

%include <tail.h>