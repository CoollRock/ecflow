%include <head.h>

# ======================================================================
# Run LOCALLY
# ======================================================================
export WK=%WK%

if [[ %SET_TO_TEST_SCRIPT% = true ]] ; then
   echo "Test only"
else

   module load valgrind/3.9.0

# user options for Memcheck:
#    --leak-check=no|summary|full     search for memory leaks at exit?  [summary]
#    --leak-resolution=low|med|high   differentiation of leak stack traces [high]
#    --show-reachable=no|yes          show reachable blocks in leak check? [no]
#    --undef-value-errors=no|yes      check for undefined value errors [yes]
#    --track-origins=no|yes           show origins of undefined values? [no]
#    --partial-loads-ok=no|yes        too hard to explain here; see manual [no]
#    --freelist-vol=<number>          volume of freed blocks queue [10000000]
#    --workaround-gcc296-bugs=no|yes  self explanatory [no]
#    --ignore-ranges=0xPP-0xQQ[,0xRR-0xSS]   assume given addresses are OK
#    --malloc-fill=<hexnumber>        fill malloc'd areas with given value
#    --free-fill=<hexnumber>          fill free'd areas with given value

   cd $WK;
   valgrind --leak-check=full --show-reachable=yes --error-exitcode=1 ACore/bin/%COMPILER_VERSION%/release/u_acore
   valgrind --leak-check=full --show-reachable=yes --error-exitcode=1 ANattr/bin/%COMPILER_VERSION%/release/u_anattr
   valgrind --leak-check=full --show-reachable=yes --error-exitcode=1 ANode/bin/%COMPILER_VERSION%/release/u_anode
   valgrind --leak-check=full --show-reachable=yes --error-exitcode=1 AParser/bin/%COMPILER_VERSION%/release/u_aparser
   valgrind --leak-check=full --show-reachable=yes --error-exitcode=1 Base/bin/%COMPILER_VERSION%/release/u_base
   valgrind --leak-check=full --show-reachable=yes --error-exitcode=1 Client/bin/%COMPILER_VERSION%/release/s_client
   valgrind --leak-check=full --show-reachable=yes --error-exitcode=1 Server/bin/%COMPILER_VERSION%/release/u_server
   valgrind --leak-check=full --show-reachable=yes --num-callers=30 --error-exitcode=1 Test/bin/%COMPILER_VERSION%/release/s_test
   valgrind --leak-check=full --show-reachable=yes --num-callers=30 --error-exitcode=1 Test/bin/%COMPILER_VERSION%/release/s_test_zombies
   valgrind --leak-check=full --show-reachable=yes --error-exitcode=1 CSim/bin/%COMPILER_VERSION%/release/c_csim
fi

%include <tail.h>